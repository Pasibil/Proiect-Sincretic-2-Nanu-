<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Proiect Arduino-Flask</title>
</head>
<body>
    <h1>Mesaje salvate</h1>
    <ul id="msgList"></ul>

    <form id="msgForm">
        <input type="text" id="msgInput" placeholder="Scrie mesaj..." />
        <button type="submit">Trimite</button>
    </form>

    <h2>Evenimente inundație</h2>
    <ul id="floodList"></ul>
    <button id="refreshFloodBtn">Reîncarcă evenimente inundație</button>

    <script>
        function refreshMessages() {
            console.log("Se încearcă reîncărcarea mesajelor...");
            fetch('/get_messages')
            .then(r => {
                console.log("Răspuns de la /get_messages:", r);
                return r.json();
            })
            .then(data => {
                console.log("Mesaje primite:", data.messages);
                const list = document.getElementById('msgList');
                list.innerHTML = '';
                data.messages.forEach(msg => {
                    const li = document.createElement('li');
                    li.textContent = msg;
                    list.appendChild(li);
                });
            })
            .catch(err => console.error("Eroare la /get_messages:", err));
        }

        function refreshFloodEvents() {
            console.log("Se încearcă reîncărcarea evenimentelor de inundație...");
            fetch('/get_flood_events')
            .then(r => {
                console.log("Răspuns de la /get_flood_events:", r);
                return r.json();
            })
            .then(data => {
                console.log("Evenimente de inundație primite:", data.flood_events);
                const list = document.getElementById('floodList');
                list.innerHTML = '';
                data.flood_events.forEach((evt, index) => {
                    const li = document.createElement('li');
                    li.textContent = evt + ' ';
                    const btn = document.createElement('button');
                    btn.textContent = 'Șterge';
                    btn.onclick = () => deleteFlood(index);
                    li.appendChild(btn);
                    list.appendChild(li);
                });
            })
            .catch(err => console.error("Eroare la /get_flood_events:", err));
        }

        function deleteFlood(index) {
            console.log("Se încearcă ștergerea evenimentului de inundație cu indexul:", index);
            fetch(`/delete_flood/${index}`, { method: 'POST' })
            .then(r => {
                console.log(`Răspuns la ștergerea evenimentului ${index}:`, r);
                return r.json();
            })
            .then(data => {
                if (data.status === 'deleted') {
                    console.log("Eveniment șters cu succes.");
                    refreshFloodEvents();
                } else {
                    console.error('Eroare la ștergerea evenimentului!');
                    alert('Eroare la ștergere!');
                }
            })
            .catch(err => console.error("Eroare la ștergerea evenimentului:", err));
        }

        document.getElementById('msgForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const msg = document.getElementById('msgInput').value.trim();
            console.log("Se încearcă trimiterea mesajului:", msg);
            if (!msg) {
                console.warn("Mesaj gol, nu se trimite.");
                return;
            }

            fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            })
            .then(r => {
                console.log("Răspuns de la /send_message:", r);
                return r.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    console.log("Mesaj trimis cu succes.");
                    document.getElementById('msgInput').value = '';
                    refreshMessages();
                } else {
                    console.error("Eroare la trimiterea mesajului.");
                }
            })
            .catch(err => console.error("Eroare la trimiterea mesajului:", err));
        });

        document.getElementById('refreshFloodBtn').addEventListener('click', () => {
            console.log("Buton reîncarcă evenimente apăsat.");
            refreshFloodEvents();
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Pagina încărcată, se încarcă mesajele...");
            refreshMessages();
            refreshFloodEvents();
        });
    </script>
</body>
</html>
